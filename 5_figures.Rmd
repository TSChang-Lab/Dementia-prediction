---
title: "5_figures"
author: "Joy_Fu"
date: "2023-05-12"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
rm(list = ls())
pacman::p_load(tidyverse, fmsb, UpSetR)
raw_data_path = "/Users/Mingzhou/Desktop/Projects/Dementia-prediction/data/"
output_path = "/Users/Mingzhou/Desktop/Projects/Dementia-prediction/output/"
# Source in useful functions
source("/Users/Mingzhou/Desktop/Projects/Dementia-prediction/code/functions.R")
```

# Part 1. Donut plot
```{r}
load(file = paste0(raw_data_path, "atlas/pheno/mod/enc_demo_map.rda"))
# Dementia cases info
dem_phecode = c("290.1", "290.11", "290.12", "290.13", "290.16")
dem_icds = c("F01", "F01.5", "F01.50", "F01.51", "F01.511", "F01.518",
             "F02.80", "F02.81", "F02.811", "F02.818", 
             "F03", "F03.9", "F03.90", "F03.91", "F03.911", "F03.918",
             "G30", "G30.0", "G30.1", "G30.8", "G30.9",
             "G31.0", "G31.01", "G31.09", "G31.1", "G31.83", "G31.85", 
             "G23.1")
dem_case_info = enc_demo_map %>% 
  # select cases only
  filter(phecode %in% dem_phecode | DiagnosisCode %in% dem_icds) %>% 
  mutate(ICD_3digit = substr(DiagnosisCode, 1, 3)) %>% 
  select(UniqueSampleId, ICD_3digit) %>% unique()
```

## 1. AMR
```{r}
load(file = paste0(raw_data_path, "modeling/AMR/sample_AMR.rda"))
case_AMR = dem_case_info %>% 
  filter(UniqueSampleId %in% sample_AMR$UniqueSampleId) %>% 
  mutate(value = 1) %>% 
  spread(key = "ICD_3digit", value = "value") %>% 
  mutate(final_diagnosis = case_when(
    !is.na(G30) ~ "G30",
    !is.na(F01) ~ "F01",
    !is.na(G31) ~ "G31",
    !is.na(F02) ~ "F02",
    !is.na(F03) ~ "F03"
  )) %>% column_to_rownames(var = "UniqueSampleId")

data_plot = table(case_AMR$final_diagnosis) %>% t() %>% as.data.frame() %>% 
  select(-Var1) %>% mutate(Freq = as.numeric(Freq))
names(data_plot) = c("category", "count")
# Compute percentages
data_plot_add = data_plot %>% 
  mutate(fraction = count/sum(count),
         ymax = cumsum(fraction),
         ymin = c(0, head(ymax, n = -1)),
         labelPosition = (ymax + ymin)/2,
         label = paste0(category, "\n count: ", count))
# Make the plot
pdf(paste0(output_path, "donut_AMR.pdf"), width = 6, height = 5)
ggplot(data_plot_add, 
       aes(ymax = ymax, ymin = ymin, xmax = 4, xmin = 3, fill = category)) +
  geom_rect() + 
  geom_text(x = 2, aes(y = labelPosition, label = label, color = category), size = 4) +
  scale_fill_brewer(palette = "Set2") +
  scale_color_brewer(palette = "Set2") +
  coord_polar(theta = "y") +
  xlim(c(-1, 4)) +
  theme_void() +
  theme(legend.position = "none")
dev.off()
```

## 2. AFR
```{r}
load(file = paste0(raw_data_path, "modeling/AFR/sample_AFR.rda"))
case_AFR = dem_case_info %>% 
  filter(UniqueSampleId %in% sample_AFR$UniqueSampleId) %>% 
  mutate(value = 1) %>% 
  spread(key = "ICD_3digit", value = "value") %>% 
  mutate(final_diagnosis = case_when(
    !is.na(G30) ~ "G30",
    !is.na(F01) ~ "F01",
    !is.na(G31) ~ "G31",
    !is.na(F02) ~ "F02",
    !is.na(F03) ~ "F03"
  )) %>% column_to_rownames(var = "UniqueSampleId")

data_plot = table(case_AFR$final_diagnosis) %>% t() %>% as.data.frame() %>% 
  select(-Var1) %>% mutate(Freq = as.numeric(Freq))
names(data_plot) = c("category", "count")
# Compute percentages
data_plot_add = data_plot %>% 
  mutate(fraction = count/sum(count),
         ymax = cumsum(fraction),
         ymin = c(0, head(ymax, n = -1)),
         labelPosition = (ymax + ymin)/2,
         label = paste0(category, "\n count: ", count))
# Make the plot
pdf(paste0(output_path, "donut_AFR.pdf"), width = 6, height = 5)
ggplot(data_plot_add, 
       aes(ymax = ymax, ymin = ymin, xmax = 4, xmin = 3, fill = category)) +
  geom_rect() + 
  geom_text(x = 2, aes(y = labelPosition, label = label, color = category), size = 4) +
  scale_fill_brewer(palette = "Set2") +
  scale_color_brewer(palette = "Set2") +
  coord_polar(theta = "y") +
  xlim(c(-1, 4)) +
  theme_void() +
  theme(legend.position = "none")
dev.off()
```

## 3. EAS
```{r}
load(file = paste0(raw_data_path, "modeling/EAS/sample_EAS.rda"))
case_EAS = dem_case_info %>% 
  filter(UniqueSampleId %in% sample_EAS$UniqueSampleId) %>% 
  mutate(value = 1) %>% 
  spread(key = "ICD_3digit", value = "value") %>% 
  mutate(final_diagnosis = case_when(
    !is.na(G30) ~ "G30",
    !is.na(F01) ~ "F01",
    !is.na(G31) ~ "G31",
    !is.na(F02) ~ "F02",
    !is.na(F03) ~ "F03"
  )) %>% column_to_rownames(var = "UniqueSampleId")

data_plot = table(case_EAS$final_diagnosis) %>% t() %>% as.data.frame() %>% 
  select(-Var1) %>% mutate(Freq = as.numeric(Freq))
names(data_plot) = c("category", "count")
# Compute percentages
data_plot_add = data_plot %>% 
  mutate(fraction = count/sum(count),
         ymax = cumsum(fraction),
         ymin = c(0, head(ymax, n = -1)),
         labelPosition = (ymax + ymin)/2,
         label = paste0(category, "\n count: ", count))
# Make the plot
pdf(paste0(output_path, "donut_EAS.pdf"), width = 6, height = 5)
ggplot(data_plot_add, 
       aes(ymax = ymax, ymin = ymin, xmax = 4, xmin = 3, fill = category)) +
  geom_rect() + 
  geom_text(x = 2, aes(y = labelPosition, label = label, color = category), size = 4) +
  scale_fill_brewer(palette = "Set2") +
  scale_color_brewer(palette = "Set2") +
  coord_polar(theta = "y") +
  xlim(c(-1, 4)) +
  theme_void() +
  theme(legend.position = "none")
dev.off()
```


# Part 1. Radar plot
```{r}
# plot setups - Color vector
colors_border = c(rgb(0.2,0.5,0.5,0.9), 
                  rgb(0.8,0.2,0.5,0.9), 
                  rgb(0.7,0.5,0.1,0.9))
colors_in = c(rgb(0.2,0.5,0.5,0.4), 
              rgb(0.8,0.2,0.5,0.4), 
              rgb(0.7,0.5,0.1,0.4))
```

## 1. AUPRC
```{r}
# Create data: note in High school for several students
amr_score = c(0.2414, 0.2677, 0.2687, 0.2755, 0.3808, 0.3813)
afr_score = c(0.2160, 0.2229, 0.2197, 0.2300, 0.3009, 0.3131)
eas_score = c(0.2897, 0.3106, 0.3004, 0.3430, 0.4070, 0.4747)
plot_auprc = as.data.frame(rbind(amr_score, afr_score, eas_score))
colnames(plot_auprc) = c("Demographics", "APOE", "Best_single_PRS", "Best_multiple_PRS", "LASSO_neuro_map", "Best_non-linear_ML")
rownames(plot_auprc) = c("AMR", "AFR", "EAS")
plot_auprc = rbind(rep(0.5, 6), rep(0.2, 6), plot_auprc)

pdf(paste0(output_path, "AUPRC_radar.pdf"), width = 8, height = 8)
radarchart(plot_auprc, axistype = 1 , maxmin = TRUE,
           #custom polygon
           pcol = colors_border, pfcol = colors_in, plwd = 3, plty = 1,
           #custom the grid
           cglcol = "grey", cglty = 1, axislabcol = "black", 
           caxislabels = seq(0.2, 0.5, 0.075), cglwd = 0.8,
           #custom labels
           vlcex = 0.9)
legend(x = 0.8, y = 1, legend = rownames(plot_auprc[-c(1,2),]), bty = "n", 
       pch = 20 , col = colors_in , text.col = "black", cex = 1, pt.cex = 2)
dev.off()
```

## 2. AUROC
```{r}
amr_score = c(0.7848, 0.7878, 0.7910, 0.7908, 0.8425, 0.8453)
afr_score = c(0.7473, 0.7485, 0.7464, 0.7571, 0.7676, 0.7497)
eas_score = c(0.8088, 0.8107, 0.8045, 0.8215, 0.8626, 0.8709)
plot_auc = as.data.frame(rbind(amr_score, afr_score, eas_score))
colnames(plot_auc) = c("Demographics", "APOE", "Best_single_PRS", "Best_multiple_PRS", "LASSO_neuro_map", "Best_non-linear_ML")
rownames(plot_auc) = c("AMR", "AFR", "EAS")
plot_auc = rbind(rep(0.9, 6), rep(0.7, 6), plot_auc)

pdf(paste0(output_path, "AUC_radar.pdf"), width = 8, height = 8)
radarchart(plot_auc, axistype = 1 , maxmin = TRUE,
           #custom polygon
           pcol = colors_border, pfcol = colors_in, plwd = 3, plty = 1,
           #custom the grid
           cglcol = "grey", cglty = 1, axislabcol = "black", 
           caxislabels = seq(0.7, 0.9, 0.05), cglwd = 0.8,
           #custom labels
           vlcex = 0.9)
legend(x = 0.8, y = 1, legend = rownames(plot_auc[-c(1,2),]), bty = "n", 
       pch = 20 , col = colors_in , text.col = "black", cex = 1, pt.cex = 2)
dev.off()
```

# Part 2. Coefficients
## 1. AMR
```{r}
load(file = paste0(raw_data_path, "modeling/AMR/coeff_table.rda"))
load(file = paste0(raw_data_path, "modeling/AMR/candidate_snps_info.rda"))
candidate_snps_info_unique = candidate_snps_info %>% 
  select(-phenotype) %>% unique() %>% drop_na()
lasso_snp_coeff_full = coeff_table %>% 
  filter(names %!in% c("age", "female", "Intercept")) %>%
  arrange(desc(abs(standardized_coefficients))) %>% 
  filter(standardized_coefficients != 0 & names %!in% c("age", "female", "Intercept")) %>% 
  separate(names, into = c("chr", "pos", "a0", "a1"), remove = F) %>% 
  mutate(chr = as.numeric(substr(chr, start = 4, stop = 1000000L)),
         pos = as.numeric(pos)) %>% 
  left_join(candidate_snps_info_unique, by = c("chr", "pos")) %>% 
  mutate(coeff_cat = if_else(standardized_coefficients >= 0, "positive", "negative")) %>% 
  mutate(magnitude = abs(standardized_coefficients)) %>% 
  select(rsID, names, chr, pos, standardized_coefficients, magnitude,
         coeff_cat, CADD, nearestGene, dist, func, 
         posMapFilt, eqtlMapFilt, ciMapFilt) %>% 
  arrange(chr, pos)
```

