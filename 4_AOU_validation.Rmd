---
title: "4_AOU_validation"
author: "Joy_Fu"
date: "2023-05-02"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
rm(list = ls())
# lapply(paste('package:', names(sessionInfo()$otherPkgs), sep = ""),
#        detach, character.only = TRUE, unload = TRUE)
pacman::p_load(tidyverse, h2o, epiflow, caret, gtsummary, MatchIt, PRROC, pROC)
raw_data_path = "/Users/Mingzhou/Desktop/Projects/Dementia-prediction/data/"
output_path = "/Users/Mingzhou/Desktop/Projects/Dementia-prediction/output/"
# Source in useful functions
source("/Users/Mingzhou/Desktop/Projects/Dementia-prediction/code/functions.R")
```

# Part 1. Retrain ATLAS models without PCs
## AMR 
### 1. Read in data
```{r}
# Read in cleaned data
load(file = paste0(raw_data_path, "modeling/AMR/sample_AMR_final.rda"))
load(file = paste0(raw_data_path, "prs/mod/atlas_prs_final.rda"))
# Join PRSs
sample_AMR_prs = sample_AMR_final %>% 
  mutate(UniqueSampleId = as.character(UniqueSampleId)) %>% 
  left_join(atlas_prs_final) %>% column_to_rownames(var = "UniqueSampleId") %>% 
  select(-c(gen_ancestry, APOE, e2count)) %>% drop_na()
dim(sample_AMR_prs) # dim = (1638,29)
# Join LASSO SNPs
load(paste0(raw_data_path, 'modeling/snp_ids/all.map.combine.id.rda'))
load(file = paste0(raw_data_path, "modeling/freeze60k_geno_freq_full_SNP.rda"))
snp_df_full = sample_AMR_final %>% 
  mutate(UniqueSampleId = as.character(UniqueSampleId)) %>% 
  left_join(genotype_df_fam, by = c("UniqueSampleId" = "IID")) %>% 
  select(-c(UniqueSampleId)) 
```

### 2. Retrain models
```{r}
h2o.init(nthreads = -1)
seed_num = 20224766
Y = "dementia"
demo_set = c("age", "female")
target.train = as.h2o(sample_AMR_prs)
target.train[,Y] = as.factor(target.train[,Y])
# Demographics only
X = c("age", "female")
demo.only = h2o.glm(training_frame = target.train, x = X, y = Y, 
                    balance_classes = T, model_id = "Demo only", 
                    nfolds = 5, fold_assignment = "Stratified",
                    seed = seed_num, family = "binomial", lambda = 0, 
                    standardize = T, keep_cross_validation_models = F)
# APOE only
X = c("e4count", "age", "female")
e4count = h2o.glm(training_frame = target.train, x = X, y = Y, 
                  balance_classes = T, model_id = "e4count", 
                  nfolds = 5, fold_assignment = "Stratified", 
                  seed = seed_num, family = "binomial", lambda = 0, 
                  standardize = T, keep_cross_validation_models = F)
# Best PRS (AD trans map)
X = c("AD_PRS_Trans_map", "age", "female")
PRS.trans.map = h2o.glm(training_frame = target.train, x = X, y = Y, 
                        balance_classes = T, model_id = "AD PRS Trans map", 
                        nfolds = 5, fold_assignment = "Stratified", 
                        seed = seed_num, family = "binomial", lambda = 0, 
                        standardize = T, keep_cross_validation_models = F)
# LASSO mapped SNPs (Step 2: fit LASSO (without PCs) with h2o model)
target.train = as.h2o(snp_df_full)
target.train[,Y] = as.factor(target.train[,Y])
X = c("age", "female", all.map.combine.id)
SNP.lasso.feature = h2o.glm(training_frame = target.train, x = X, y = Y, 
                            balance_classes = T, model_id = "LASSO features", 
                            nfolds = 5, fold_assignment = "Stratified", 
                            seed = seed_num, family = "binomial", 
                            alpha = 0.6, lambda_search = TRUE, standardize = T, 
                            keep_cross_validation_models = F)
snps_AMR_all_map = SNP.lasso.feature@model$variable_importances %>% 
  as.data.frame() %>% filter(variable %!in% demo_set) %>% 
  filter(scaled_importance > 0) %>% pull(variable)
print(length(snps_AMR_all_map))
X = c("age", "female", snps_AMR_all_map)
aml_all_map = h2o.automl(x = X, y = Y, training_frame = target.train, 
                         balance_classes = TRUE, max_models = 10, nfolds = 5, 
                         seed = seed_num, sort_metric = "AUCPR", 
                         include_algos = "GLM")
allmap.nopc = aml_all_map@leader
```

```{r}
all_model_metric = c()
all_model_performance = c()
# Extract results
model_list = c("demo.only", "e4count", "PRS.trans.map", "allmap.nopc")
for (i in 1:length(model_list)) {
  print(paste0("Model: ", model_list[i]))
  # Run extraction function
  extract_cv = extract_cv_results(get(model_list[i]))
  model_metric = t(extract_cv[[1]]) %>% as.data.frame() %>% 
    mutate(mark = model_list[i])
  model_performance = extract_cv[[2]] %>% as.data.frame() %>% 
    mutate(mark = model_list[i])
  if (i == 1) {
    all_model_metric = model_metric
    all_model_performance = model_performance
  } else {
    all_model_metric = rbind(all_model_metric, model_metric)
    all_model_performance = rbind(all_model_performance, model_performance)
  }
}
# Join results together
nopc_model_metric = rbind(all_model_metric)
nopc_model_performance = rbind(all_model_performance)
nopc_model_summary_atlas = nopc_model_metric %>% inner_join(nopc_model_performance)
```

```{r}
snps_AMR_all_map_final = allmap.nopc@model$variable_importances %>% 
  as.data.frame() %>% filter(variable %!in% demo_set) %>% 
  filter(scaled_importance > 0) %>% pull(variable)
```

## AFR 
### 1. Read in data
```{r}
# Read in cleaned data
load(file = paste0(raw_data_path, "modeling/AFR/sample_AFR_final.rda"))
# Join PRSs
sample_AFR_prs = sample_AFR_final %>% 
  mutate(UniqueSampleId = as.character(UniqueSampleId)) %>% 
  left_join(atlas_prs_final) %>% column_to_rownames(var = "UniqueSampleId") %>% 
  select(-c(gen_ancestry, APOE, e2count)) %>% drop_na()
dim(sample_AFR_prs) # dim = (1092,29)
# Join LASSO SNPs
snp_df_full = sample_AFR_final %>% 
  mutate(UniqueSampleId = as.character(UniqueSampleId)) %>% 
  left_join(genotype_df_fam, by = c("UniqueSampleId" = "IID")) %>% 
  select(-c(UniqueSampleId)) 
```

### 2. Retrain models
```{r}
seed_num = 2394
Y = "dementia"
demo_set = c("age", "female")
target.train = as.h2o(sample_AFR_prs)
target.train[,Y] = as.factor(target.train[,Y])
# Demographics only
X = c("age", "female")
demo.only = h2o.glm(training_frame = target.train, x = X, y = Y, 
                    balance_classes = T, model_id = "Demo only", 
                    nfolds = 5, fold_assignment = "Stratified",
                    seed = seed_num, family = "binomial", lambda = 0, 
                    standardize = T, keep_cross_validation_models = F)
# APOE only
X = c("e4count", "age", "female")
e4count = h2o.glm(training_frame = target.train, x = X, y = Y, 
                  balance_classes = T, model_id = "e4count", 
                  nfolds = 5, fold_assignment = "Stratified", 
                  seed = seed_num, family = "binomial", lambda = 0, 
                  standardize = T, keep_cross_validation_models = F)
# Best PRS (AD trans map)
X = c("AD_PRS_AFR_indsig", "age", "female")
PRS.trans.map = h2o.glm(training_frame = target.train, x = X, y = Y, 
                        balance_classes = T, model_id = "AD PRS AFR indsig", 
                        nfolds = 5, fold_assignment = "Stratified", 
                        seed = seed_num, family = "binomial", lambda = 0, 
                        standardize = T, keep_cross_validation_models = F)
# LASSO mapped SNPs (Step 2: fit LASSO (without PCs) with h2o model)
target.train = as.h2o(snp_df_full)
target.train[,Y] = as.factor(target.train[,Y])
X = c("age", "female", all.map.combine.id)
SNP.lasso.feature = h2o.glm(training_frame = target.train, x = X, y = Y, 
                            balance_classes = T, model_id = "LASSO features", 
                            nfolds = 5, fold_assignment = "Stratified", 
                            seed = seed_num, family = "binomial", 
                            alpha = 0, lambda_search = TRUE, standardize = T, 
                            keep_cross_validation_models = F)
snps_AFR_all_map = SNP.lasso.feature@model$variable_importances %>% 
  as.data.frame() %>% filter(variable %!in% demo_set) %>% 
  filter(scaled_importance > 0) %>% pull(variable)
print(length(snps_AFR_all_map))
X = c("age", "female", snps_AFR_all_map[1:3])
aml_all_map = h2o.automl(x = X, y = Y, training_frame = target.train, 
                         balance_classes = TRUE, max_models = 10, nfolds = 5, 
                         seed = seed_num, sort_metric = "AUCPR", 
                         include_algos = "GLM")
allmap.nopc = aml_all_map@leader
```

```{r}
all_model_metric = c()
all_model_performance = c()
# Extract results
model_list = c("demo.only", "e4count", "PRS.trans.map", "allmap.nopc")
for (i in 1:length(model_list)) {
  print(paste0("Model: ", model_list[i]))
  # Run extraction function
  extract_cv = extract_cv_results(get(model_list[i]))
  model_metric = t(extract_cv[[1]]) %>% as.data.frame() %>% 
    mutate(mark = model_list[i])
  model_performance = extract_cv[[2]] %>% as.data.frame() %>% 
    mutate(mark = model_list[i])
  if (i == 1) {
    all_model_metric = model_metric
    all_model_performance = model_performance
  } else {
    all_model_metric = rbind(all_model_metric, model_metric)
    all_model_performance = rbind(all_model_performance, model_performance)
  }
}
# Join results together
nopc_model_metric = rbind(all_model_metric)
nopc_model_performance = rbind(all_model_performance)
nopc_model_summary_atlas2 = nopc_model_metric %>% inner_join(nopc_model_performance)
```

```{r}
snps_AFR_all_map_final = allmap.nopc@model$variable_importances %>% 
  as.data.frame() %>% filter(variable %!in% demo_set) %>% 
  filter(scaled_importance > 0) %>% pull(variable)
```

## EAS 
### 1. Read in data
```{r}
# Read in cleaned data
load(file = paste0(raw_data_path, "modeling/EAS/sample_EAS_final.rda"))
# Join PRSs
sample_EAS_prs = sample_EAS_final %>% 
  mutate(UniqueSampleId = as.character(UniqueSampleId)) %>% 
  left_join(atlas_prs_final) %>% column_to_rownames(var = "UniqueSampleId") %>% 
  select(-c(gen_ancestry, APOE, e2count)) %>% drop_na()
dim(sample_EAS_prs) # dim = (975,29)
# Join LASSO SNPs
snp_df_full = sample_EAS_final %>% 
  mutate(UniqueSampleId = as.character(UniqueSampleId)) %>% 
  left_join(genotype_df_fam, by = c("UniqueSampleId" = "IID")) %>% 
  select(-c(UniqueSampleId)) 
```

### 2. Retrain models
```{r}
seed_num = 970103
Y = "dementia"
demo_set = c("age", "female")
target.train = as.h2o(sample_EAS_prs)
target.train[,Y] = as.factor(target.train[,Y])
# Demographics only
X = c("age", "female")
demo.only = h2o.glm(training_frame = target.train, x = X, y = Y, 
                    balance_classes = T, model_id = "Demo only", 
                    nfolds = 5, fold_assignment = "Stratified",
                    seed = seed_num, family = "binomial", lambda = 0, 
                    standardize = T, keep_cross_validation_models = F)
# APOE only
X = c("e4count", "age", "female")
e4count = h2o.glm(training_frame = target.train, x = X, y = Y, 
                  balance_classes = T, model_id = "e4count", 
                  nfolds = 5, fold_assignment = "Stratified", 
                  seed = seed_num, family = "binomial", lambda = 0, 
                  standardize = T, keep_cross_validation_models = F)
# Best PRS (AD trans map)
X = c("AD_PRS_Trans_map", "age", "female")
PRS.trans.map = h2o.glm(training_frame = target.train, x = X, y = Y, 
                        balance_classes = T, model_id = "AD PRS Trans map", 
                        nfolds = 5, fold_assignment = "Stratified", 
                        seed = seed_num, family = "binomial", lambda = 0, 
                        standardize = T, keep_cross_validation_models = F)
# LASSO mapped SNPs (Step 2: fit LASSO (without PCs) with h2o model)
target.train = as.h2o(snp_df_full)
target.train[,Y] = as.factor(target.train[,Y])
X = c("age", "female", all.map.combine.id)
SNP.lasso.feature = h2o.glm(training_frame = target.train, x = X, y = Y, 
                            balance_classes = T, model_id = "LASSO features", 
                            nfolds = 5, fold_assignment = "Stratified", 
                            seed = seed_num, family = "binomial", 
                            alpha = 1, lambda_search = TRUE, standardize = T, 
                            keep_cross_validation_models = F)
snps_EAS_all_map = SNP.lasso.feature@model$variable_importances %>% 
  as.data.frame() %>% filter(variable %!in% demo_set) %>% 
  filter(scaled_importance > 0) %>% pull(variable)
print(length(snps_EAS_all_map))
X = c("age", "female", snps_EAS_all_map)
aml_all_map = h2o.automl(x = X, y = Y, training_frame = target.train, 
                         balance_classes = TRUE, max_models = 10, nfolds = 5, 
                         seed = seed_num, sort_metric = "AUCPR", 
                         include_algos = "GLM")
allmap.nopc = aml_all_map@leader
```

```{r}
all_model_metric = c()
all_model_performance = c()
# Extract results
model_list = c("demo.only", "e4count", "PRS.trans.map", "allmap.nopc")
for (i in 1:length(model_list)) {
  print(paste0("Model: ", model_list[i]))
  # Run extraction function
  extract_cv = extract_cv_results(get(model_list[i]))
  model_metric = t(extract_cv[[1]]) %>% as.data.frame() %>% 
    mutate(mark = model_list[i])
  model_performance = extract_cv[[2]] %>% as.data.frame() %>% 
    mutate(mark = model_list[i])
  if (i == 1) {
    all_model_metric = model_metric
    all_model_performance = model_performance
  } else {
    all_model_metric = rbind(all_model_metric, model_metric)
    all_model_performance = rbind(all_model_performance, model_performance)
  }
}
# Join results together
nopc_model_metric = rbind(all_model_metric)
nopc_model_performance = rbind(all_model_performance)
nopc_model_summary_atlas3 = nopc_model_metric %>% inner_join(nopc_model_performance)
```

```{r}
snps_EAS_all_map_final = allmap.nopc@model$variable_importances %>% 
  as.data.frame() %>% filter(variable %!in% demo_set) %>% 
  filter(scaled_importance > 0) %>% pull(variable)
```

```{r}
snps_combined_atlas = c(snps_AMR_all_map_final, snps_AFR_all_map_final, 
                        snps_EAS_all_map_final) %>% unique()
length(snps_combined_atlas) # N = 89
```

## Outputs for AOU (combined SNPs)
```{r}
load(file = paste0(raw_data_path, "modeling/beta_merge_raw.rda"))
snp_beta_short = beta_merge_raw %>% rowwise() %>% 
  mutate(beta_AD_map = mean(c(beta_EUR_map, beta_AFR_map, beta_trans_map), na.rm = T)) %>% 
  mutate(beta_all_map = sum(c(beta_AD_map, beta_LBD_map, beta_PD_map, 
                              beta_PSP_map, beta_STROKE_map), na.rm = T)) %>% 
  select(rsid, beta_all_map) %>% dplyr::rename("beta" = "beta_all_map") %>% 
  filter(rsid %in% snps_combined_atlas)
# Output LASSO SNP table - 
lasso_map_snp = snp_beta_short %>% 
  separate(rsid, into = c("chr", "pos", "a0", "a1"), 
           sep = ":", remove = FALSE) %>% 
  mutate(pos_plus = as.character(as.numeric(pos) + 1)) %>% 
  mutate(output_var = paste0(chr, ":", pos, "-", pos_plus)) 
dim(lasso_map_snp) # (89,8)
save(lasso_map_snp, file = paste0(raw_data_path, "AOU/lasso_map_snp.rda"))
write.table(lasso_map_snp, 
            file = paste0(output_path, "AOU_validation/lasso_map_snp.txt"),
            sep = "\t", quote = F, row.names = F, col.names = T)
```


# Part 2. Validation
```{r}
# Read in AOU data
load(file = paste0(raw_data_path, "AOU/apoe_status.rda"))
load(file = paste0(raw_data_path, "AOU/pred_prs_final_trans.rda"))
load(file = paste0(raw_data_path, "AOU/pred_prs_final_afr.rda"))
load(file = paste0(raw_data_path, "AOU/lasso_snp.rda"))
load(file = paste0(raw_data_path, "AOU/AMR/final_eligible_AOU_amr.rda"))
load(file = paste0(raw_data_path, "AOU/AFR/final_eligible_AOU_afr.rda"))
# Load ATLAS sample
# load(file = paste0(raw_data_path, "modeling/freeze60k_geno_freq_full_SNP.rda"))
# load(file = paste0(raw_data_path, "prs/mod/atlas_prs_final.rda"))
load(file = paste0(raw_data_path, "modeling/AMR/matched_atlas_amr.rda"))
load(file = paste0(raw_data_path, "modeling/AFR/matched_atlas_afr.rda"))
```

## AMR sample
### 1. Clean AOU sample
```{r}
# Combine AOU and ATLAS data for matching
clean_AOU_amr = final_eligible_AOU_amr %>% 
  left_join(pred_prs_final_trans) %>% left_join(apoe_status) %>% 
  left_join(lasso_snp) %>% mutate(db = "AOU") %>% 
  select(-c(AD_PRS_trans_map)) %>% drop_na() %>% 
  dplyr::rename("AD_PRS_Trans_map" = "AD_PRS_trans_map_norm")
dim(clean_AOU_amr) # dim = (2148,100)
clean_atlas_amr = matched_atlas_amr %>% mutate(db = "ATLAS") %>% 
  mutate(PatientID = as.character(PatientID)) %>% 
  left_join(genotype_df_fam, by = c("PatientID" = "IID")) %>% 
  left_join(atlas_prs_final, by = c("PatientID" = "UniqueSampleId")) %>% 
  select(all_of(names(clean_AOU_amr)))
dim(clean_atlas_amr) # (1638,100)
combined_df_amr = rbind(clean_AOU_amr, clean_atlas_amr) %>% 
  as.data.frame() %>% mutate(db = if_else(db == "AOU", 0, 1))
dim(combined_df_amr) # (3340,100)
```

```{r}
atlas_amr = clean_atlas_amr %>% 
  select(age, female, n_encounter, n_diagnosis, record_length, enc_per_yr, 
         dementia, AD_PRS_Trans_map, e4count) %>% mutate(db = 1)
aou_amr = final_AOU_AMR %>% 
  select(age, female, n_encounter, n_diagnosis, record_length, enc_per_yr, 
         dementia, AD_PRS_Trans_map, e4count) %>% mutate(db = 0)
rbind(aou_amr, atlas_amr) %>% as.data.frame() %>% 
  tbl_summary(by = db) %>% add_p()
```

### 2. Match AOU on ATLAS (by case/control)
```{r}
# By cases
combined_df_case = combined_df_amr %>% filter(dementia == 1)
matchit_case_db = matchit(db ~ enc_per_yr + n_diagnosis + n_encounter + record_length, 
                          data = combined_df_case, method = "nearest", ratio = 1)
matched_case_db = match.data(matchit_case_db)
matched_case_db %>% 
  select(age, female, n_encounter, n_diagnosis, record_length, enc_per_yr, 
         db, AD_PRS_Trans_map, e4count) %>% 
  tbl_summary(by = db) %>% add_p()
# By control
combined_df_control = combined_df_amr %>% filter(dementia == 0)
matchit_control_db = matchit(db ~ enc_per_yr + n_diagnosis + n_encounter + record_length, 
                             data = combined_df_control, method = "nearest", ratio = 1)
matched_control_db = match.data(matchit_control_db)
matched_control_db %>% 
  select(age, female, n_encounter, n_diagnosis, record_length, enc_per_yr, 
         db, AD_PRS_Trans_map, e4count) %>% 
  tbl_summary(by = db) %>% add_p()
```

```{r}
# Combine to get the final sample
final_AOU_AMR = rbind(matched_case_db, matched_control_db) %>% 
  as.data.frame() %>% filter(db == 0) 
dim(final_AOU_AMR) # (1553,103)
save(final_AOU_AMR, file = paste0(raw_data_path, "modeling/AMR/final_AOU_AMR.rda"))
final_AOU_AMR_id = final_AOU_AMR %>% select(PatientID) %>% 
  mutate(FID = 0) %>% rename("IID" = "PatientID") %>% 
  select(FID, IID)
write.table(final_AOU_AMR_id, file = paste0(raw_data_path, 'modeling/AMR/final_AOU_AMR_id.txt'),
            sep = " ", quote = F, row.names = F, col.names = F)
```

### 3. Perform testing
Remember to run retrain ATLAS models first
```{r}
load(file = paste0(raw_data_path, "modeling/AMR/final_AOU_AMR.rda"))
target.test = as.h2o(final_AOU_AMR)
target.test[,Y] = as.factor(target.test[,Y])
```

```{r}
pred.demo.only = h2o.predict(object = demo.only, newdata = target.test, standardize = T)
pred_demo_df = cbind(final_AOU_AMR$dementia, as.data.frame(pred.demo.only))
names(pred_demo_df)[1] = "true_label"
pr_demo = pr.curve(scores.class0 = pred_demo_df$p1, weights.class0 = pred_demo_df$true_label)
# AUCPR
pr_demo$auc.integral
roc_demo = roc(pred_demo_df$true_label, pred_demo_df$p1)
auc(roc_demo)
```


```{r}
pred.e4count = h2o.predict(object = e4count, newdata = target.test, standardize = T)
pred_e4count_df = cbind(final_AOU_AMR$dementia, as.data.frame(pred.e4count))
names(pred_e4count_df)[1] = "true_label"
pr_e4count = pr.curve(scores.class0 = pred_e4count_df$p1, 
                      weights.class0 = pred_e4count_df$true_label)
pr_e4count$auc.integral
roc_e4count = roc(pred_e4count_df$true_label, pred_e4count_df$p1)
auc(roc_e4count)
```

```{r}
pred.best.PRS = h2o.predict(object = PRS.trans.map, newdata = target.test, standardize = T)
pred_best_PRS_df = cbind(final_AOU_AMR$dementia, as.data.frame(pred.best.PRS))
names(pred_best_PRS_df)[1] = "true_label"
pr_best_PRS = pr.curve(scores.class0 = pred_best_PRS_df$p1, 
                       weights.class0 = pred_best_PRS_df$true_label)
pr_best_PRS$auc.integral
roc_PRS = roc(pred_best_PRS_df$true_label, pred_best_PRS_df$p1)
auc(roc_PRS)
```

```{r}
pred.lasso.snp = h2o.predict(object = allmap.nopc, newdata = target.test, standardize = T)
pred_lasso_snp_df = cbind(final_AOU_AMR$dementia, as.data.frame(pred.lasso.snp))
names(pred_lasso_snp_df)[1] = "true_label"
pr_lasso_snp = pr.curve(scores.class0 = pred_lasso_snp_df$p1, 
                        weights.class0 = pred_lasso_snp_df$true_label)
pr_lasso_snp$auc.integral
roc_lasso = roc(pred_lasso_snp_df$true_label, pred_lasso_snp_df$p1)
auc(roc_lasso)
```

## AFR sample
### 1. Clean AOU sample
```{r}
# Combine AOU and ATLAS data for matching
clean_AOU_afr = final_eligible_AOU_afr %>% 
  left_join(pred_prs_final_afr) %>% left_join(apoe_status) %>% 
  left_join(lasso_snp) %>% mutate(db = "AOU") %>% 
  select(-c(AD_PRS_AFR_indsig)) %>% drop_na() %>% 
  dplyr::rename("AD_PRS_AFR_indsig" = "AD_PRS_AFR_indsig_norm")
dim(clean_AOU_afr) # dim = (9728,100)
clean_atlas_afr = matched_atlas_afr %>% mutate(db = "ATLAS") %>% 
  mutate(PatientID = as.character(PatientID)) %>% 
  left_join(genotype_df_fam, by = c("PatientID" = "IID")) %>% 
  left_join(atlas_prs_final, by = c("PatientID" = "UniqueSampleId")) %>% 
  select(all_of(names(clean_AOU_afr)))
dim(clean_atlas_afr) # (1092,100)
combined_df_afr = rbind(clean_AOU_afr, clean_atlas_afr) %>% 
  as.data.frame() %>% mutate(db = if_else(db == "AOU", 0, 1))
dim(combined_df_afr) # (10820,100)
```

```{r}
atlas_afr = clean_atlas_afr %>% 
  select(age, female, n_encounter, n_diagnosis, record_length, enc_per_yr, 
         dementia, AD_PRS_AFR_indsig, e4count) %>% mutate(db = 1)
aou_afr = final_AOU_AFR %>% 
  select(age, female, n_encounter, n_diagnosis, record_length, enc_per_yr, 
         dementia, AD_PRS_AFR_indsig, e4count) %>% mutate(db = 0)
rbind(aou_afr, atlas_afr) %>% as.data.frame() %>% 
  tbl_summary(by = db) %>% add_p()
```

### 2. Match AOU on ATLAS (by case/control)
```{r}
# By cases
combined_df_case = combined_df_afr %>% filter(dementia == 1)
matchit_case_db = matchit(db ~ enc_per_yr + n_diagnosis + n_encounter + record_length, 
                          data = combined_df_case, method = "nearest", ratio = 1)
matched_case_db = match.data(matchit_case_db)
matched_case_db %>% 
  select(age, female, n_encounter, n_diagnosis, record_length, enc_per_yr, 
         db, AD_PRS_Trans_map, e4count) %>% 
  tbl_summary(by = db) %>% add_p()
# By control
combined_df_control = combined_df_afr %>% filter(dementia == 0)
matchit_control_db = matchit(db ~ enc_per_yr + n_diagnosis + n_encounter + record_length, 
                             data = combined_df_control, method = "nearest", ratio = 1)
matched_control_db = match.data(matchit_control_db)
matched_control_db %>% 
  select(age, female, n_encounter, n_diagnosis, record_length, enc_per_yr, 
         db, AD_PRS_Trans_map, e4count) %>% 
  tbl_summary(by = db) %>% add_p()
```

```{r}
# Combine to get the final sample
final_AOU_AFR = rbind(matched_case_db, matched_control_db) %>% 
  as.data.frame() %>% filter(db == 0) 
dim(final_AOU_AFR) # (1092,103)
save(final_AOU_AFR, file = paste0(raw_data_path, "modeling/AFR/final_AOU_AFR.rda"))
final_AOU_AFR_id = final_AOU_AFR %>% select(PatientID) %>% 
  mutate(FID = 0) %>% rename("IID" = "PatientID") %>% 
  select(FID, IID)
write.table(final_AOU_AFR_id, file = paste0(raw_data_path, 'modeling/AFR/final_AOU_AFR_id.txt'),
            sep = " ", quote = F, row.names = F, col.names = F)
```

### 3. Perform testing
Remember to run retrain ATLAS models first
```{r}
load(file = paste0(raw_data_path, "modeling/AFR/final_AOU_AFR.rda"))
target.test = as.h2o(final_AOU_AFR)
target.test[,Y] = as.factor(target.test[,Y])
```

```{r}
pred.demo.only = h2o.predict(object = demo.only, newdata = target.test, standardize = T)
pred_demo_df = cbind(final_AOU_AFR$dementia, as.data.frame(pred.demo.only))
names(pred_demo_df)[1] = "true_label"
pr_demo = pr.curve(scores.class0 = pred_demo_df$p1, weights.class0 = pred_demo_df$true_label)
# AUCPR
pr_demo$auc.integral
roc_demo = roc(pred_demo_df$true_label, pred_demo_df$p1)
auc(roc_demo)
```

```{r}
pred.e4count = h2o.predict(object = e4count, newdata = target.test, standardize = T)
pred_e4count_df = cbind(final_AOU_AFR$dementia, as.data.frame(pred.e4count))
names(pred_e4count_df)[1] = "true_label"
pr_e4count = pr.curve(scores.class0 = pred_e4count_df$p1, 
                      weights.class0 = pred_e4count_df$true_label)
pr_e4count$auc.integral
roc_e4count = roc(pred_e4count_df$true_label, pred_e4count_df$p1)
auc(roc_e4count)
```

```{r}
pred.best.PRS = h2o.predict(object = PRS.trans.map, newdata = target.test, standardize = T)
pred_best_PRS_df = cbind(final_AOU_AFR$dementia, as.data.frame(pred.best.PRS))
names(pred_best_PRS_df)[1] = "true_label"
pr_best_PRS = pr.curve(scores.class0 = pred_best_PRS_df$p1, 
                       weights.class0 = pred_best_PRS_df$true_label)
pr_best_PRS$auc.integral
roc_PRS = roc(pred_best_PRS_df$true_label, pred_best_PRS_df$p1)
auc(roc_PRS)
```

```{r}
pred.lasso.snp = h2o.predict(object = allmap.nopc, newdata = target.test, standardize = T)
pred_lasso_snp_df = cbind(final_AOU_AFR$dementia, as.data.frame(pred.lasso.snp))
names(pred_lasso_snp_df)[1] = "true_label"
pr_lasso_snp = pr.curve(scores.class0 = pred_lasso_snp_df$p1, 
                        weights.class0 = pred_lasso_snp_df$true_label)
pr_lasso_snp$auc.integral
roc_lasso = roc(pred_lasso_snp_df$true_label, pred_lasso_snp_df$p1)
auc(roc_lasso)
```


